// packages/db/prisma/schema/network.prisma

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?   // Для авторизации по паролю
  firstName     String?
  lastName      String?
  
  // Базовая иерархия
  role          UserRole  @default(USER)
  
  businessId    String
  
  // Гибкие разрешения
  customRoles   UserCustomRole[]    // Шорткаты (напр. "Технолог")
  permissions   PermissionOverride[] // Индивидуальные атомы прав
  
  // Связи для процесса Handshake
  transfersFrom Handshake[] @relation("FormerOwner")
  transfersTo   Handshake[] @relation("NewOwner")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([businessId])
  @@index([email])
}

model Handshake {
  id            String    @id @default(cuid())
  businessId    String
  
  formerOwnerId String
  formerOwner   User      @relation("FormerOwner", fields: [formerOwnerId], references: [id])
  
  newOwnerId    String
  newOwner      User      @relation("NewOwner", fields: [newOwnerId], references: [id])
  
  status        HandshakeStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  expiresAt     DateTime  // Должно быть createdAt + 168 часов
  
  @@index([businessId])
}

model CustomRole {
  id            String    @id @default(cuid())
  name          String    // "Технолог", "Шеф-бариста"
  businessId    String
  permissions   String[]  // Атомы прав (напр. "ttk.edit")
  users         UserCustomRole[]

  @@index([businessId])
}

model UserCustomRole {
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  customRoleId String
  customRole   CustomRole @relation(fields: [customRoleId], references: [id])

  @@id([userId, customRoleId])
}

model PermissionOverride {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  permission String   // Атом права (напр. "schedule.edit")
  value      Boolean  @default(true)

  @@index([userId])
}

// Модели из Module 09 (Assets)
model Asset {
  id              String   @id @default(cuid())
  name            String
  serialNumber    String?
  unitId          String
  businessId      String
  status          AssetStatus @default(OPERATIONAL)
  criticality     Int      @default(1)
  
  createdAt       DateTime @default(now())

  @@index([unitId])
  @@index([businessId])
}

enum UserRole {
  SUPERUSER
  OWNER
  CO_OWNER // Бывший OWNER в процессе передачи
  USER
}

enum HandshakeStatus {
  PENDING
  COMPLETED
  REVOKED // Мгновенная отмена
}

enum AssetStatus {
  OPERATIONAL
  WARNING
  CRITICAL_FAILURE
  MAINTENANCE
  RETIRED
}
