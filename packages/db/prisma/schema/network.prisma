// packages/db/prisma/schema/network.prisma
// Модуль 00: Core Network & Identity

model User {
  id            String   @id @default(cuid())
  email        String   @unique
  passwordHash String?
  firstName    String?
  lastName     String?
  role         UserRole @default(USER)

  businessId String
  business   Business @relation("BusinessMembers", fields: [businessId], references: [id])

  ownedBusiness Business? @relation("BusinessOwner")
  customRoles   UserCustomRole[]
  permissions   PermissionOverride[]

  transfersFrom Handshake[] @relation("FormerOwner")
  transfersTo   Handshake[] @relation("NewOwner")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([email])
}

model Business {
  id          String  @id @default(cuid())
  name        String
  isArchived  Boolean @default(false) // [REF]: is_archived -> isArchived

  ownerId String? @unique
  owner   User?   @relation("BusinessOwner", fields: [ownerId], references: [id])

  newOwnerId      String?
  handshakeStatus HandshakeStatus @default(IDLE)
  handshakeAt     DateTime?
  enterprises     Enterprise[]
  users           User[]       @relation("BusinessMembers")
  units           Unit[]
  assets          Asset[]
  handshakes      Handshake[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
}

model Enterprise {
  id          String   @id @default(cuid())
  name        String
  businessId  String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  units       Unit[]
  isArchived  Boolean  @default(false) // [REF]: is_archived -> isArchived

  @@unique([name, businessId])
  @@index([businessId])
}

model Unit {
  id           String   @id @default(cuid())
  name         String
  address      String?
  timezone     String   @default("UTC")
  capabilities String[]
  tags         String[]
  allowedIp    String?  // [REF]: allowed_ip -> allowedIp
  enterpriseId String
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  isArchived Boolean @default(false) // [REF]: is_archived -> isArchived
  assets     Asset[]

  @@index([businessId])
  @@index([enterpriseId])
}

model Handshake {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  formerOwnerId String
  formerOwner   User   @relation("FormerOwner", fields: [formerOwnerId], references: [id])

  newOwnerId String
  newOwner   User   @relation("NewOwner", fields: [newOwnerId], references: [id])

  status    HandshakeStatus @default(PENDING)
  createdAt DateTime        @default(now())
  expiresAt DateTime

  @@index([businessId])
  @@index([formerOwnerId]) // [NEW]: Индекс для оптимизации поиска истории
  @@index([newOwnerId])    // [NEW]: Индекс для оптимизации поиска истории
}

model CustomRole {
  id          String           @id @default(cuid())
  name        String
  businessId  String
  permissions String[]
  users       UserCustomRole[]

  @@index([businessId])
}

model UserCustomRole {
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  customRoleId String
  customRole   CustomRole @relation(fields: [customRoleId], references: [id])

  @@id([userId, customRoleId])
}

model PermissionOverride {
  id         String  @id @default(cuid())
  userId     String
  user       User    @relation(fields: [userId], references: [id])
  permission String
  value      Boolean @default(true)

  @@index([userId])
}

model Asset {
  id           String   @id @default(cuid())
  name         String
  serialNumber String?
  unitId       String
  unit         Unit     @relation(fields: [unitId], references: [id])
  businessId   String
  business     Business @relation(fields: [businessId], references: [id])

  status      AssetStatus @default(OPERATIONAL)
  criticality Int         @default(1)

  createdAt DateTime @default(now())

  @@index([unitId])
  @@index([businessId])
}

enum UserRole {
  SUPERUSER
  OWNER
  CO_OWNER
  USER
}

enum HandshakeStatus {
  IDLE
  PENDING
  COMPLETED
  REVOKED
}

enum AssetStatus {
  OPERATIONAL
  WARNING
  CRITICAL_FAILURE
  MAINTENANCE
  RETIRED
}
