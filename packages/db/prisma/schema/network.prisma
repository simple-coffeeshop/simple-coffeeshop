// packages/db/prisma/schema/network.prisma

model Business {
  id         String  @id @default(cuid())
  name       String
  isArchived Boolean @default(false)

  // Ownership
  ownerId String? @unique
  owner   User?   @relation("BusinessOwner", fields: [ownerId], references: [id])

  enterprises      Enterprise[]
  members          Member[]
  units            Unit[]
  assets           Asset[]
  handshakes       Handshake[]
  employeeProfiles EmployeeProfile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
}

model Member {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  role       UserRole @default(USER)
  isArchived Boolean  @default(false)

  createdAt DateTime @default(now())

  @@unique([userId, businessId])
  @@index([businessId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  userAgent String?
  ipAddress String?
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model EmployeeProfile {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  firstName String
  lastName  String
  phone     String @unique

  // Связь с User (аккаунтом) описывается через User.externalEmployeeId
  user User?

  isArchived Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([businessId])
}

model Enterprise {
  id         String   @id @default(cuid())
  name       String
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  units      Unit[]
  isArchived Boolean @default(false)

  @@unique([name, businessId])
  @@index([businessId])
}

model Unit {
  id       String  @id @default(cuid())
  name     String
  address  String?
  timezone String  @default("UTC")

  capabilities UnitCapability[]
  allowedIps   String[]         @default([])

  enterpriseId String
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  businessId   String
  business     Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)

  isArchived Boolean @default(false)
  assets     Asset[]

  createdAt DateTime @default(now())

  @@index([businessId])
  @@index([enterpriseId])
}

model Handshake {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  formerOwnerId String
  formerOwner   User   @relation("FormerOwner", fields: [formerOwnerId], references: [id])

  // [EVA_FIX]: Используем Email вместо ID для внешних инвайтов
  // Удалена связь newOwner: User, чтобы избежать конфликта имен Prisma [cite: 8]
  newOwnerEmail String
  status        HandshakeStatus @default(PENDING)
  effectiveAt   DateTime // Кулдаун 168ч
  createdAt     DateTime        @default(now())

  @@index([businessId])
  @@index([formerOwnerId])
}

model CustomRole {
  id          String           @id @default(cuid())
  name        String
  businessId  String
  permissions String[]
  users       UserCustomRole[]

  @@index([businessId])
}

model UserCustomRole {
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  customRoleId String
  customRole   CustomRole @relation(fields: [customRoleId], references: [id])

  @@id([userId, customRoleId])
}

model PermissionOverride {
  id         String  @id @default(cuid())
  userId     String
  user       User    @relation(fields: [userId], references: [id])
  permission String
  value      Boolean @default(true)

  @@index([userId])
}

model Asset {
  id           String   @id @default(cuid())
  name         String
  serialNumber String?
  unitId       String
  unit         Unit     @relation(fields: [unitId], references: [id])
  businessId   String
  business     Business @relation(fields: [businessId], references: [id])

  status      AssetStatus @default(OPERATIONAL)
  criticality Int         @default(1)

  createdAt DateTime @default(now())

  @@index([unitId])
  @@index([businessId])
}
