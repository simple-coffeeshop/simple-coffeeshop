<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Coffee-ERP | Strict Bio-lock</title>
    <style>
        :root {
            --primary: #f0533a; --primary-hover: #d9442f; --error: #dc3545;
            --bg-page: #f0f2f5; --bg-card: #ffffff;
            --text-main: #1a1a1b; --text-muted: #65676b;
            --border: #e4e6eb; --radius: 20px;
            --shadow-float: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; overflow: hidden; background-color: var(--bg-page); position: fixed; }
        .viewport-wrapper { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; padding: 20px; z-index: 1; }
        .bio-card { width: 100%; max-width: 400px; background: var(--bg-card); border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 40px; display: flex; flex-direction: column; position: relative; }
        .bio-header { margin-bottom: 24px; text-align: center; }
        h1 { font-size: 22px; font-weight: 800; color: var(--text-main); }
        .bio-form { display: grid; gap: 14px; }
        .form-row { display: flex; flex-direction: column; gap: 4px; position: relative; }
        label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-main); }
        .input-wrapper { position: relative; width: 100%; }
        .input-field { width: 100%; height: 50px; padding: 0 16px; padding-right: 44px; background: #f8fafc; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; outline: none; transition: all 0.2s; -webkit-appearance: none; }
        .input-field:focus { border-color: var(--primary); background: #fff; }
        .input-field.invalid { border-color: var(--error); background: #fffcfc; }
        .error-hint { color: var(--error); font-size: 11px; font-weight: 600; margin-top: 4px; display: none; animation: fadeIn 0.2s ease; }
        .error-hint.visible { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-2px); } to { opacity: 1; transform: translateY(0); } }
        .calendar-trigger { position: absolute; right: 0; top: 0; bottom: 0; width: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: var(--text-muted); }
        
        /* CALENDAR OVERLAY */
        .calendar-overlay { background: #fff; z-index: 1000; display: none; flex-direction: column; border: 1px solid var(--border); animation: fadeInCal 0.2s ease; }
        @keyframes fadeInCal { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .calendar-overlay.active { display: flex; }
        .cal-head { display: flex; gap: 8px; margin-bottom: 15px; }
        .cal-sel { flex: 1; height: 40px; border-radius: 10px; background: #f8fafc; border: 1px solid var(--border); font-size: 14px; font-weight: 600; text-align: center; text-align-last: center; outline: none; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; border-radius: 8px; }
        .cal-day:hover { background: #f0f2f5; color: var(--primary); }
        .cal-day.selected { background: var(--primary); color: #fff; font-weight: 700; }
        .cal-close-btn { margin-top: 15px; height: 44px; background: #f0f2f5; color: var(--text-main); border: none; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; }

        @media (min-width: 641px) {
            .calendar-overlay { position: absolute; bottom: 60px; left: -20px; right: -20px; border-radius: 18px; box-shadow: var(--shadow-float); padding: 20px; }
        }
        @media (max-width: 640px) {
            .viewport-wrapper { padding: 0; }
            .bio-card { height: 100dvh; border-radius: 0; justify-content: center; padding: 24px; max-width: 100%; }
            .calendar-overlay { position: fixed; bottom: 0; left: 0; right: 0; border-radius: 24px 24px 0 0; padding: 24px; padding-bottom: max(24px, env(safe-area-inset-bottom)); box-shadow: 0 -10px 40px rgba(0,0,0,0.2); border: none; border-top: 1px solid var(--border); animation: slideUpSheet 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
            @keyframes slideUpSheet { from { transform: translateY(100%); } to { transform: translateY(0); } }
        }
        .btn-submit { margin-top: 10px; width: 100%; height: 54px; background: var(--primary); color: white; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-submit:disabled { opacity: 0.4; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="viewport-wrapper">
    <article class="bio-card">
        <header class="bio-header">
            <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
        </header>

        <form class="bio-form" id="bioForm" novalidate onsubmit="return false">
            <div class="form-row" id="row-fio">
                <label>–§–ò–û</label>
                <div class="input-wrapper">
                    <input type="text" class="input-field" id="fio" placeholder="–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–ø–æ–ª—å—Å–∫–∏–π –ö." onblur="validateField('fio')">
                </div>
                <span class="error-hint">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</span>
            </div>

            <div class="form-row" id="row-phone">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <div class="input-wrapper">
                    <input type="tel" class="input-field" id="phone" placeholder="+7 (___) ___-__-__" onblur="validateField('phone')">
                </div>
                <span class="error-hint">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä</span>
            </div>

            <div class="form-row" id="row-tg">
                <label>Telegram</label>
                <div class="input-wrapper">
                    <input type="text" class="input-field" id="tg" placeholder="@username" onblur="validateField('tg')">
                </div>
                <span class="error-hint">–ù—É–∂–µ–Ω @ –∏ –ª–∞—Ç–∏–Ω–∏—Ü–∞</span>
            </div>

            <div class="form-row" id="row-birth">
                <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                <div class="input-wrapper">
                    <input type="text" class="input-field" id="birth" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì" inputmode="numeric" oninput="handleDateInput(this)" onblur="validateField('birth')">
                    <div class="calendar-trigger" onclick="togglePicker(event)">üìÖ</div>
                </div>
                <span class="error-hint">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ (–î–î.–ú–ú.–ì–ì–ì–ì)</span>

                <div class="calendar-overlay" id="picker" onclick="event.stopPropagation()">
                    <div class="cal-head">
                        <select class="cal-sel" id="mSel" onchange="drawDays()"></select>
                        <select class="cal-sel" id="ySel" onchange="drawDays()"></select>
                    </div>
                    <div class="cal-grid" id="daysBox"></div>
                    <button class="cal-close-btn" onclick="closePicker()">–ó–∞–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
                </div>
            </div>

            <button type="submit" class="btn-submit" id="submitBtn" disabled onclick="alert('–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω!')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </form>
    </article>
</div>

<script>
    const inputs = {
        fio: document.getElementById('fio'),
        phone: document.getElementById('phone'),
        tg: document.getElementById('tg'),
        birth: document.getElementById('birth')
    };

    // --- –ú–ê–°–ö–ê –¢–ï–õ–ï–§–û–ù–ê ---
    inputs.phone.addEventListener('input', (e) => {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
        e.target.value = !x[3] ? '+7 (' + (x[2] || '') : '+7 (' + x[2] + ') ' + x[3] + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : '');
        checkAll();
    });

    // --- –ù–û–í–ê–Ø –°–¢–†–û–ì–ê–Ø –ú–ê–°–ö–ê –î–ê–¢–´ ---
    function handleDateInput(el) {
        let val = el.value;
        const lastChar = val.slice(-1);

        // 1. –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: –µ—Å–ª–∏ –≤–≤–µ–ª–∏ "1." –∏–ª–∏ "1 ", –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ "01."
        if (['.', ',', ' ', '/'].includes(lastChar)) {
            // –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
            let raw = val.slice(0, -1);
            // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç - –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "1"), –¥–µ–ª–∞–µ–º "01"
            let parts = raw.split(/[\.\,\s\/]/); 
            if (parts.length > 0) {
                let lastPart = parts[parts.length - 1];
                if (lastPart.length === 1 && /\d/.test(lastPart)) {
                    // –ó–∞–º–µ–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —á–∞—Å—Ç—å
                    parts[parts.length - 1] = '0' + lastPart;
                    val = parts.join('.') + '.'; // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
                }
            }
        }

        // 2. –ñ–µ—Å—Ç–∫–∞—è —á–∏—Å—Ç–∫–∞: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
        let digits = val.replace(/\D/g, '');

        // 3. –û–±—Ä–µ–∑–∞–µ–º –ª–∏—à–Ω–µ–µ (–º–∞–∫—Å–∏–º—É–º 8 —Ü–∏—Ñ—Ä: –î–î–ú–ú–ì–ì–ì–ì)
        // –≠—Ç–æ –∏ –µ—Å—Ç—å —Ñ–∏–∫—Å –¥–ª—è 01.02.90.1 -> –ª–∏—à–Ω—è—è –µ–¥–∏–Ω–∏—Ü–∞ –ø—Ä–æ—Å—Ç–æ –æ—Ç—Å–µ—á–µ—Ç—Å—è
        if (digits.length > 8) digits = digits.substring(0, 8);

        // 4. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –î–î.–ú–ú.–ì–ì–ì–ì
        let formatted = '';
        if (digits.length > 0) formatted += digits.substring(0, 2);
        if (digits.length >= 2) formatted += '.';
        if (digits.length > 2) formatted += digits.substring(2, 4);
        if (digits.length >= 4) formatted += '.';
        if (digits.length > 4) formatted += digits.substring(4, 8);

        el.value = formatted;
        checkAll();
    }

    // --- –í–ê–õ–ò–î–ê–¶–ò–Ø ---
    function validateField(id) {
        const el = inputs[id];
        const val = el.value.trim();
        let ok = false;
        const errorMsg = document.querySelector(`#row-${id} .error-hint`);

        if (id === 'fio') ok = val.length >= 3;
        if (id === 'phone') ok = val.length === 18;
        if (id === 'tg') ok = /^@[a-zA-Z0-9_]{3,30}$/.test(val);
        if (id === 'birth') {
            const parts = val.split('.');
            if (parts.length === 3) {
                const d = parseInt(parts[0]), m = parseInt(parts[1]), y = parseInt(parts[2]);
                ok = d > 0 && d <= 31 && m > 0 && m <= 12 && y > 1940 && y < 2025;
            }
        }

        if (!ok && val !== '') { 
            el.classList.add('invalid');
            if(errorMsg) errorMsg.classList.add('visible');
        } else if (val === '') { 
            el.classList.add('invalid');
            if(errorMsg) errorMsg.classList.add('visible');
        } else {
            el.classList.remove('invalid');
            if(errorMsg) errorMsg.classList.remove('visible');
        }
        checkAll();
    }

    function checkAll() {
        const fio = inputs.fio.value.trim().length >= 3;
        const ph = inputs.phone.value.length === 18;
        const tg = /^@[a-zA-Z0-9_]{3,30}$/.test(inputs.tg.value);
        
        let br = false;
        const parts = inputs.birth.value.split('.');
        if (parts.length === 3 && inputs.birth.value.length === 10) { // 10 chars: dd.mm.yyyy
             const y = parseInt(parts[2]);
             if (y > 1940 && y < 2025) br = true;
        }
        document.getElementById('submitBtn').disabled = !(fio && ph && tg && br);
    }

    // --- –ö–ê–õ–ï–ù–î–ê–†–¨ ---
    const picker = document.getElementById('picker');
    const mSel = document.getElementById('mSel');
    const ySel = document.getElementById('ySel');
    const daysBox = document.getElementById('daysBox');

    function initCal() {
        const months = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
        months.forEach((m, i) => mSel.add(new Option(m, i)));
        const y = new Date().getFullYear();
        for (let i = y; i >= y - 80; i--) ySel.add(new Option(i, i));
        ySel.value = 1995;
        drawDays();
    }

    function drawDays() {
        daysBox.innerHTML = '';
        const m = parseInt(mSel.value), y = parseInt(ySel.value);
        const total = new Date(y, m + 1, 0).getDate();
        for (let d = 1; d <= total; d++) {
            const div = document.createElement('div');
            div.className = 'cal-day';
            div.innerText = d;
            div.onclick = () => {
                const pad = (n) => n.toString().padStart(2, '0');
                inputs.birth.value = `${pad(d)}.${pad(m+1)}.${y}`;
                inputs.birth.classList.remove('invalid');
                document.querySelector('#row-birth .error-hint').classList.remove('visible');
                closePicker();
                checkAll();
            };
            daysBox.appendChild(div);
        }
    }

    function togglePicker(e) {
        if(e) e.stopPropagation();
        const active = picker.classList.contains('active');
        if (active) closePicker(); else picker.classList.add('active');
    }

    function closePicker() { picker.classList.remove('active'); }
    
    document.addEventListener('click', (e) => {
        if (!picker.contains(e.target) && !e.target.classList.contains('calendar-trigger')) {
            closePicker();
        }
    });

    initCal();
</script>

</body>
</html>
