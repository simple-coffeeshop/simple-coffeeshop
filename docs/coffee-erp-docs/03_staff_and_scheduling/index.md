# Модуль 03: Планирование и Учет

<!--toc:start-->

- [Модуль 03: Планирование и Учет](#модуль-03-планирование-и-учет)
  - [1. Назначение и Архитектура](#1-назначение-и-архитектура)
  - [2. Глобальные настройки и Контроль](#2-глобальные-настройки-и-контроль)
    - [2.1 Защита от забытых таймеров (Anti-Zombie)](#21-защита-от-забытых-таймеров-anti-zombie)
    - [2.2 Валидация и Ограничения](#22-валидация-и-ограничения)
  - [3. Процесс планирования и Обмен сменами](#3-процесс-планирования-и-обмен-сменами)
    - [3.1 Сбор пожеланий (Availability)](#31-сбор-пожеланий-availability)
    - [3.2 Алгоритм «Рукопожатия» (Shift Swaps)](#32-алгоритм-рукопожатия-shift-swaps)
    - [3.3 Приглашенные сотрудники (Guest Staff)](#33-приглашенные-сотрудники-guest-staff)
  - [4. Жизненный цикл смены](#4-жизненный-цикл-смены)
  - [5. Очередь разработки](#5-очередь-разработки)
  <!--toc:end-->

## 1. Назначение и Архитектура

Модуль управляет полным циклом рабочего времени: от сбора пожеланий до формирования утвержденного табеля для выплат
.

- **Capacity Management:** Система следит за «станциями» (ролями). Каждой роли задается лимит сотрудников.
  При превышении лимита система выдает предупреждение.
- **Изоляция ставок (Rate Privacy):** Управляющий видит часы всех сотрудников, но финансовые поля приглашенных
  гостей (Guests) всегда возвращают `null`.

## 2. Глобальные настройки и Контроль

### 2.1 Защита от забытых таймеров (Anti-Zombie)

Для предотвращения раздувания ФОТ внедрен алгоритм авто-закрытия:

- **Триггер:** Превышение лимита смены (например, 20 часов).
- **Действие:** Таймер останавливается принудительно, смена получает статус «Закрыта авто».

### 2.2 Валидация и Ограничения

- **Блокировка раннего старта:** Запрет на запуск таймера ранее чем за N минут до плана.
- **Shift Gate:** Сотрудник не может заполнять чек-листы (Модуль 08), если у него нет активной открытой смены
  .

## 3. Процесс планирования и Обмен сменами

### 3.1 Сбор пожеланий (Availability)

Сотрудники выбирают временные шаблоны (Утро/Вечер). Назначение смены вопреки статусу «Не могу» требует
`Force Override`, что фиксируется в логах.

### 3.2 Алгоритм «Рукопожатия» (Shift Swaps)

Сотрудники могут меняться сменами внутри одного Юнита через механизм подтверждения:

1. **Инициация:** Сотрудник А нажимает «Предложить обмен» на своей смене.
2. **Выбор:** Выбирает сотрудника Б или выставляет смену в «общий маркет».
3. **Подтверждение:** Сотрудник Б принимает запрос.
4. **Валидация:** Система проверяет отсутствие наслоений и лимиты отдыха (не менее 8 часов между сменами)
   .

### 3.3 Приглашенные сотрудники (Guest Staff)

- **Сетевой поиск:** Поиск любого сотрудника сети по ФИО для вызова на смену.
- **Начисление:** Часы подтверждаются на текущей точке, но финансово учитываются в «Домашнем юните»
  .

## 4. Жизненный цикл смены

1. **Планирование:** Создание черновика, публикация и уведомление штата.
2. **Фиксация факта (Timer):** При нажатии «Старт» система делает **Rate Snapshot** ставки.
3. **Утверждение (Approval):** В конце месяца табель блокируется и передается в Модуль 04.

## 5. Очередь разработки

| ID        | Задача                                   | Статус         |
| :-------- | :--------------------------------------- | :------------- |
| [DEV-3.1] | Валидация смен (Security Middleware)     | В разработке   |
| [ARCH-01] | Логика Ролей и Лимитов (Conflict Alerts) | Спроектировано |
| [DEV-3.4] | Логика обмена сменами (Handshake API)    | В разработке   |
