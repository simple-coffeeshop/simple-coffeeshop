# Модуль 02: Технологические карты и База знаний

<!--toc:start-->
- [Модуль 02: Технологические карты и База знаний](#модуль-02-технологические-карты-и-база-знаний)
  - [1. Назначение и Бизнес-логика](#1-назначение-и-бизнес-логика)
  - [2. Интеллектуальные механизмы](#2-интеллектуальные-механизмы)
    - [2.1 "Умный текст" (Smart Editor)](#21-умный-текст-smart-editor)
    - [2.2 Пассивная сигнализация (Passive Alerts)](#22-пассивная-сигнализация-passive-alerts)
    - [2.3 Калькулятор партии (Batch Scaling)](#23-калькулятор-партии-batch-scaling)
    - [2.4 Управление Deprecated-рецептами](#24-управление-deprecated-рецептами)
  - [3. Версионирование и Целостность](#3-версионирование-и-целостность)
  - [4. Очередь разработки](#4-очередь-разработки)
<!--toc:end-->

## 1. Назначение и Бизнес-логика

Модуль является единым источником правды о технологии производства, себестоимости и КБЖУ блюд.

- **Гибридная сущность:** Рецепт может быть конечным Блюдом или Заготовкой (ингредиентом).
  Если отмечен как `Заготовка`, он автоматически становится доступен в Складе (Модуль 01) для инвентаризации.
- **Dynamic Costing:** Система использует SCSS-переменные для визуализации финансовых показателей.
  Цены в ТТК — «живые». При изменении закупочной цены в
  Модуле 01 срабатывает **Auto-COGS Recalculation** — фоновый пересчет маржи всех связанных техкарт.
- **Нутрициология:** КБЖУ рассчитывается автоматически на основе данных ингредиентов.
  В интерфейсе добавлен **Nutrition Progress Bar** (кольцевые диаграммы БЖУ).

## 2. Интеллектуальные механизмы

### 2.1 "Умный текст" (Smart Editor)

В редакторе используется символ `$`, вызывающий Floating Panel поиска.
Система вставляет токен `Link(Ingredient_ID)`, который визуализируется как интерактивный Chip.
Реализована обязательная санитизация ввода для защиты от XSS.

### 2.2 Пассивная сигнализация (Passive Alerts)

При падении маржи ниже целевой (триггер: рост цен на сырье), рецепт получает статус **LOW MARGIN**.
В реестре такие карты выделяются эффектом **Low Margin Glow** (пульсирующая красная рамка).

### 2.3 Калькулятор партии (Batch Scaling)

Реализован пересчет граммовок «на лету» (Client-side).
В режиме **Batch Scaling Preview** система визуально разделяет базовый вес и
текущий расчет разными цветами шрифта для исключения ошибок повара.

### 2.4 Управление Deprecated-рецептами

- **Для сотрудников:** Блюда со «сломанными» ингредиентами исчезают из списков.
- **Для редакторов ТТК:** Появляется отдельная вкладка «Deprecated» (видима только при наличии таких рецептов).
В ней блюда отображаются с пометкой о неисправном ингредиенте для оперативного исправления состава.

## 3. Версионирование и Целостность

- **Version Control & Visual Diff:** Каждое сохранение создает новую версию.
  Поддерживается **Visual Diff Visualizer** — подсветка измененных строк (зеленый/красный) при сравнении версий.
- **Concurrency Control:** Реализована блокировка редактирования (Optimistic Locking).
  Если два менеджера открыли одну ТТК, система предупредит о конфликте правок.
- **Reference Integrity:** Блокировка удаления (409 Conflict) ингредиентов из Склада,
  если они задействованы в ТТК.
- **Media Storage:** Локальное хранение фото и видео (/public/uploads)
  с поддержкой **Lazy Media Loading** для экономии трафика на точках.

## 4. Очередь разработки

| ID        | Задача                                        | Статус       |
| :-------- | :-------------------------------------------- | :----------- |
| [DEV-2.1] | Сервис Динамической Себестоимости и Auto-COGS | В разработке |
| [DEV-2.3] | Компонент "Умный текст" (Editor Chips)        | В разработке |
| [DEV-2.5] | Версионирование и Visual Diff Visualizer      | В разработке |
| [DEV-2.6] | Генератор Аллерген-карты и Progress Bars      | В разработке |
| [DEV-2.7] | Concurrency Control (Optimistic Locking)      | В разработке |
