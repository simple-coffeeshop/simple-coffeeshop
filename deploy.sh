#!/bin/bash

# [EVA_PROTIP]: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -e

echo "üöÄ [EVA]: –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π Coffee ERP..."

# 1. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
echo "üì• –ü–æ–ª—É—á–∞—é —Å–≤–µ–∂–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git..."
git pull origin main

# 2. –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "üõ†Ô∏è –°–±–æ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ –∏ —Ñ–∞–π–ª .env.prod
docker compose -f docker-compose.prod.yml --env-file .env.prod up -d --build

# 3. –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤ (—ç–∫–æ–Ω–æ–º–∏–º –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ)
echo "üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–ª–æ–µ–≤ —Å–±–æ—Ä–∫–∏..."
docker image prune -f

# 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (Prisma)
echo "üíé –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ö–µ–º—ã Prisma..."
# –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤–Ω—É—Ç—Ä–∏ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ API
docker exec sc-api-prod pnpm prisma db push --accept-data-loss

# 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ROOT-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
echo "üåë –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ROOT-–∞–¥–º–∏–Ω–∞..."
docker exec sc-api-prod node dist/packages/db/scripts/bootstrap-root.js

echo "‚ú® [EVA]: –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç."
